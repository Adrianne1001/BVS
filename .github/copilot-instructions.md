# BVS (Bogsy Video Store) - AI Coding Agent Instructions

## Project Overview
BVS is an ASP.NET Core 9.0 MVC web application for managing video rental operations. It tracks customers, video inventory, and rental transactions with overdue fee calculations.

**Tech Stack:** .NET 9.0, Entity Framework Core 9, SQL Server LocalDB, C#

## Architecture & Data Flow

### Repository Pattern with Dependency Injection
- **Interfaces** (in [Interfaces/](Interfaces/)): Define contracts for data operations
  - `ICustomerRepository`, `IVideoRepository`, `IRentalRepository`
  - All data access must go through these interfaces
  
- **Repositories** (in [Repositories/](Repositories/)): Implement data access logic
  - Example pattern in [CustomerRepository.cs](Repositories/CustomerRepository.cs):
    ```csharp
    public bool Add(Customer customer) {
        _context.Add(customer);
        return Save();  // Commits changes
    }
    ```
  - **Critical:** Always call `Save()` after mutations - it returns true/false for success
  - Use async methods (`GetAll()`, `GetByIdAsync()`) where defined

- **Controllers** (in [Controllers/](Controllers/)): Inject repository interfaces via constructor
  - Example in [CustomerController.cs](Controllers/CustomerController.cs):
    ```csharp
    public CustomerController(ICustomerRepository customerRepository, 
                             IRentalRepository rentalRepository)
    ```
  - Controllers never directly access `DbContext`; always use repository methods

### Entity Relationships
- **Customer** → **Rental** (one-to-many): A customer can have multiple rentals
- **Video** → **Rental** (one-to-many): A video can be rented multiple times
- [Rental.cs](Models/Rental.cs) uses `[ForeignKey]` attributes on navigation properties
- Always load related entities via repositories before passing to views

### ViewModels Pattern
- [ViewModels/](ViewModels/) folder contains view-specific models
  - Example: [ReportCustomerViewModel.cs](ViewModels/ReportCustomerViewModel.cs) combines Customer rental history with calculated due fees
  - Controllers transform domain models into ViewModels before passing to views
  - **Never** pass raw domain models directly to views if view needs computed data

## Key Conventions

### Folder Structure
- `Models/` - EF Core entities (Customer, Video, Rental) with validation attributes
- `Data/Enum/` - Domain enums (Genre, VideoType, RentDuration, Sex)
- `Interfaces/` - Repository contracts (all extend same pattern)
- `Repositories/` - Data access implementations
- `Controllers/` - MVC controllers following CRUD conventions
- `Views/` - Razor views organized by controller name
- `ViewModels/` - Shape data for specific view requirements

### Property Naming
- Domain models use **PascalCase** for public properties
- Navigation properties are typed as `Entity?` (nullable) with `[ForeignKey]` attributes
- Enums stored as properties use their enum type directly (EF Core handles conversion)

### Database & Migrations
- Connection string in [appsettings.json](appsettings.json): LocalDB instance `BVSdb`
- Migrations in [Migrations/](Migrations/) folder - auto-generated by EF Core
- **When adding new properties to models:**
  1. Update the model class in [Models/](Models/)
  2. Run: `dotnet ef migrations add MigrationName`
  3. Run: `dotnet ef database update`

### Validation
- Use **data annotations** on model properties:
  - `[EmailAddress(ErrorMessage = "...")]` for email fields
  - `[Phone(ErrorMessage = "...")]` for phone fields
  - `[Required]` for mandatory fields
  - ModelState validation in controller action: `if (!ModelState.IsValid) return View(model);`

## Critical Business Logic
- **Overdue Fee Calculation** in [CustomerController.cs](Controllers/CustomerController.cs#L59-L74):
  - Formula: `DueFees = Max(0, (DaysOverdue * 5 * QtyRented))`
  - Run in Report action, not stored in DB (calculated on-demand)
  - Note: Demo version uses minutes instead of days (commented out)

- **Inventory Tracking** in [Video.cs](Models/Video.cs):
  - `QtyTotal` - total stock, `QtyIn` - available, `QtyOut` - rented out
  - Rentals update these quantities; update repositories accordingly

## Development Workflows

### Running the Application
```powershell
dotnet run
# Launches at https://localhost:7282 with ASP.NET Core development server
# Also available at http://localhost:5282 (non-SSL)
```

### Building
```powershell
dotnet build
# Compiles to bin/Debug/net9.0/
```

### Database Operations
```powershell
# Create/apply migrations
dotnet ef migrations add InitialCreate
dotnet ef database update

# View pending changes
dotnet ef migrations list
dotnet ef database info
```

## When Adding Features

1. **New Repository Method:** Add interface in `Interfaces/IXxxRepository.cs`, implement in `Repositories/XxxRepository.cs`
2. **New Model Property:** Update model class, create migration, update forms/views
3. **New View Data:** Create ViewModel in `ViewModels/`, return from controller action
4. **New Action:** Add method to controller, create corresponding view, consider injecting additional repositories
5. **Form Validation:** Add attributes to model properties, check ModelState in controller

## Common Patterns in This Codebase

- **Async operations:** Always use `async/await` for repository calls (GetAll, GetByIdAsync)
- **Boolean returns:** Repository methods return bool to indicate success; check return value or use conditionally
- **Dependency visibility:** See [Program.cs](Program.cs) for registered services - only inject interfaces already registered
- **View conventions:** Views stored in `Views/{ControllerName}/{ActionName}.cshtml`
- **Computed properties:** Calculate in controller/ViewModel, not in domain models
